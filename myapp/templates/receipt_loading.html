{% extends 'base.html' %}
{% load static %}
{% block contents %} 

<section id="loading-text" class="center-text" style="margin-top: 200px;">
  <h1 style="font-family: Pretendard-ExtraBold;">영수증을 인식 중입니다... </h1>
  <div id="loading">
      <div class="loader"></div>
  </div>
</section>

<section id="error-section" class="center-text" style="display: none; margin-top: 200px;">
  <div>
    <h1 id="error-message" style="font-family: Pretendard-ExtraBold; color: black;"></h1>
  </div>
  <div>
    <button onclick="retryScan()" class="retry-button" style="margin-top: 50px;">다시 시도하기</button>
  </div>
</section>

<script>
  function initiateOCR() {
      document.getElementById("loading-text").style.display = "block";
      document.getElementById("error-section").style.display = "none";

      fetch("{% url 'run_capture_and_process' %}")
      .then(response => response.json())
      .then(data => {
          if (data.status === 'completed' && data.redirect_url) {
              window.location.href = data.redirect_url;
          } else {
              document.getElementById("loading-text").style.display = "none";
              document.getElementById("error-section").style.display = "block";
              document.getElementById("error-message").innerText = data.message || '영수증 인식 중 오류가 발생했습니다.';
          }
      })
      .catch(() => {
          document.getElementById("loading-text").style.display = "none";
          document.getElementById("error-section").style.display = "block";
          document.getElementById("error-message").innerText = '영수증 인식 중 오류가 발생했습니다.';
      });
  }

  function retryScan() {
      initiateOCR();
  }

  document.addEventListener("DOMContentLoaded", function() {
      initiateOCR();
  });
</script>

<style>
  .retry-button {
      font-family: Pretendard-Bold;
      font-size: 1.2em;
      padding: 10px 20px;
      background-color: #f4872e;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
  }
</style>

{% endblock %}
